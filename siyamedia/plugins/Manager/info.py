# Authored By Certified Coders © 2025
import asyncio
from pyrogram import filters, enums, types
from pyrogram.errors import PeerIdInvalid, RPCError, FloodWait
from pyrogram.types import Message, InlineKeyboardMarkup, InlineKeyboardButton

from siyamedia import app


def get_full_name(user):
    return f"{user.first_name} {user.last_name}" if user.last_name else user.first_name


def get_last_seen(status):
    if isinstance(status, str):
        status = status.replace("UserStatus.", "").lower()
    elif isinstance(status, enums.UserStatus):
        status = status.name.lower()

    return {
        "online": "?? ??????",
        "offline": "?? ???????",
        "recently": "? ????????",
        "last_week": "?? ??s? ????",
        "last_month": "?? ??s? ?????",
        "long_ago": "?? ???? ???? ???"
    }.get(status, "? ???????")


@app.on_message(filters.command(["info", "userinfo", "whois"]))
async def whois_handler(_, message: Message):
    try:
        if message.reply_to_message:
            user = message.reply_to_message.from_user
        elif len(message.command) > 1:
            user = await app.get_users(message.command[1])
        else:
            user = message.from_user

        loading = await message.reply("?? <b>????????? ?s?? ????...</b>")
        await asyncio.sleep(0.5)

        chat_user = await app.get_chat(user.id)

        name = get_full_name(user)
        username = f"@{user.username}" if user.username else "?/?"
        bio = chat_user.bio or "?? ???"
        dc_id = getattr(user, "dc_id", "?/?")
        last_seen = get_last_seen(user.status)
        lang = getattr(user, "language_code", "?/?")

        text = (
            f"?? <b>?s?? ????</b>\n"
            f"???????????????\n"
            f"? <b>?s?? ??:</b> <code>{user.id}</code>\n"
            f"? <b>????:</b> {name}\n"
            f"? <b>?s??????:</b> {username}\n"
            f"? <b>??s? s???:</b> {last_seen}\n"
            f"? <b>?????????? ??:</b> {dc_id}\n"
            f"? <b>????????:</b> {lang}\n"
            f"???????????????\n"
            f"? <b>????????:</b> {'??s ?' if user.is_verified else '?? ??'}\n"
            f"? <b>???????:</b> {'??s ??' if user.is_premium else '?? ??'}\n"
            f"? <b>???:</b> {'??s ??' if user.is_bot else '?? ??'}\n"
            f"? <b>s??? ???????:</b> {'??s ??' if getattr(user, 'is_scam', False) else '?? ??'}\n"
            f"? <b>???? ???????:</b> {'??s ??' if getattr(user, 'is_fake', False) else '?? ??'}\n"
            f"? <b>??????? ???????:</b> {'??s ??' if user.photo else '?? ??'}\n"
            f"???????????????\n"
            f"? <b>???:</b> <code>{bio}</code>"
        )

        profile_url = f"https://t.me/{user.username}" if user.username else f"tg://user?id={user.id}"
        buttons = InlineKeyboardMarkup([[
            InlineKeyboardButton("?? ???? ???????", url=profile_url),
            InlineKeyboardButton("?? ?????", url="tg://settings")
        ]])

        await app.edit_message_text(
            chat_id=message.chat.id,
            message_id=loading.id,
            text=text,
            parse_mode=enums.ParseMode.HTML,
            reply_markup=buttons
        )

    except PeerIdInvalid:
        await message.reply("?? ? ??????'? ???? ???? ?s??.")
    except FloodWait as e:
        await asyncio.sleep(e.value)
        return await whois_handler(_, message)
    except RPCError as e:
        await message.reply(f"?? ??? ?????:\n<code>{e}</code>")
    except Exception as e:
        await message.reply(f"?? ?????:\n<code>{e}</code>")
